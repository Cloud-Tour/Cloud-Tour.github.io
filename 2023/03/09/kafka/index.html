<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kafka | Hexo</title>
  <meta name="description" content="Kafka Kafka是最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式日志系统（也可以当做MQ系统），常见可以用于web&#x2F;nginx日志、访问日志，消息服务等等，Linkedin于2010年贡献给了Apache基金会并成为顶级开源项目。主要应用场景是：日志收集系统和消息系统。Kafka主要设计目标如下：  以时间复杂度为O(1)的方式">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka">
<meta property="og:url" content="http://cloud-tour.github.io/2023/03/09/kafka/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Kafka Kafka是最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式日志系统（也可以当做MQ系统），常见可以用于web&#x2F;nginx日志、访问日志，消息服务等等，Linkedin于2010年贡献给了Apache基金会并成为顶级开源项目。主要应用场景是：日志收集系统和消息系统。Kafka主要设计目标如下：  以时间复杂度为O(1)的方式">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-topic.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-partition.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-partition.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-offset.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-producer.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-consume.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/consumer_group%E7%A4%BA%E4%BE%8B.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/consumer_group%E7%A4%BA%E4%BE%8B2.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka%E5%88%86%E5%8C%BA%E5%89%AF%E6%9C%AC.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/message%E7%89%A9%E7%90%86%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-zookeeper.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E7%82%B9%E5%AF%B9%E7%82%B9%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%A8%A1%E5%BC%8F.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%A8%A1%E5%BC%8F.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-ISR-1.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-ISR-2.png">
<meta property="og:image" content="http://cloud-tour.github.io/2023/03/09/kafka/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAAAAACIM/FCAAACh0lEQVR4Ae3ch5W0OgyG4dt/mQJ2xgQPzJoM1m3AbALrxzrf28FzsoP0HykJEEAAAUQTBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEkKK0789+GK/I2ezfQB522PnS1qc8pGgXvr4tE4aY0XOUWlGImThWgyCk6DleixzE7qwBkg/MGiDPlVVAyp1VQGrPKiACDhFI6VkF5LmzCki+sg7IwDoglnVAil0IMkeG9CyUiwsxLFUVFzJJOQaKCjFCDN9RXMjIX7W6ztZXZDKKCyn8sWJvH+nca7WHDN9lROlAliPH9iRKCPI4cswFJQWxB46toLQgQ9jhn5QYZA9DOkoMUoQde5YapAxDWkoNYsOQR3KQd9CxUnIQF4S49CB9ENKlBxmDEKsFUgMCCCCAAHIrSF61f6153Ajy8nyiPr8L5MXnmm4CyT2fzN4DUvHZ+ntA2tOQBRBAAAEEEEAAAQQQ7ZBaC6TwSiDUaYHQ2yuB0MN+ft+43whyrs4rgVCjBUKTFshLC6TUAjGA3AxSaYFYLZBOC2RUAsk8h5qTg9QcbEoOsoQhQ2qQhsO5xCD5dgB5JQaZ+KBKGtKecvR81Ic0ZDjByKdDx0rSEDZ/djQbH+bkIdvfJFm98BfV8hD2zprfVdlu9PxVeyYAkciREohRAplJCaRSAplJCcQogTjSAdlyHRBvSAekJR0QRzogA+mADJkOiCPSAPEtqYBshlRAXC43hxix2QiOuEZkVERykGyNo9idIZKE0HO7XrG6OiMShlDWjstVzdPgXtUH9v0CEidAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQP4HgjZxTpdEii0AAAAASUVORK5CYII=">
<meta property="og:image" content="http://cloud-tour.github.io/2023/03/09/kafka/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAAAAACIM/FCAAACh0lEQVR4Ae3ch5W0OgyG4dt/mQJ2xgQPzJoM1m3AbALrxzrf28FzsoP0HykJEEAAAUQTBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEkKK0789+GK/I2ezfQB522PnS1qc8pGgXvr4tE4aY0XOUWlGImThWgyCk6DleixzE7qwBkg/MGiDPlVVAyp1VQGrPKiACDhFI6VkF5LmzCki+sg7IwDoglnVAil0IMkeG9CyUiwsxLFUVFzJJOQaKCjFCDN9RXMjIX7W6ztZXZDKKCyn8sWJvH+nca7WHDN9lROlAliPH9iRKCPI4cswFJQWxB46toLQgQ9jhn5QYZA9DOkoMUoQde5YapAxDWkoNYsOQR3KQd9CxUnIQF4S49CB9ENKlBxmDEKsFUgMCCCCAAHIrSF61f6153Ajy8nyiPr8L5MXnmm4CyT2fzN4DUvHZ+ntA2tOQBRBAAAEEEEAAAQQQ7ZBaC6TwSiDUaYHQ2yuB0MN+ft+43whyrs4rgVCjBUKTFshLC6TUAjGA3AxSaYFYLZBOC2RUAsk8h5qTg9QcbEoOsoQhQ2qQhsO5xCD5dgB5JQaZ+KBKGtKecvR81Ic0ZDjByKdDx0rSEDZ/djQbH+bkIdvfJFm98BfV8hD2zprfVdlu9PxVeyYAkciREohRAplJCaRSAplJCcQogTjSAdlyHRBvSAekJR0QRzogA+mADJkOiCPSAPEtqYBshlRAXC43hxix2QiOuEZkVERykGyNo9idIZKE0HO7XrG6OiMShlDWjstVzdPgXtUH9v0CEidAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQP4HgjZxTpdEii0AAAAASUVORK5CYII=">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka-PageCache.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BC%98%E5%8C%96.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%9A%84%E6%96%B9%E5%BC%8F.png">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E7%9A%84%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1.jpg">
<meta property="og:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/%E5%90%AF%E5%8A%A8Kafka%E6%97%A5%E5%BF%97.png">
<meta property="article:published_time" content="2023-03-09T10:19:44.444Z">
<meta property="article:modified_time" content="2023-03-09T10:22:26.848Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="kafka">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9E%B6%E6%9E%84.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://cloud-tour.github.io/2023/03/09/kafka/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/Cloud-Tour" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar2.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Cloud-Tour</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Development Engineer &amp; Java</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> MaoMing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/Cloud-Tour" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/51%E5%8D%95%E7%89%87%E6%9C%BA/">51单片机</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javase/">javase</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/juc/">juc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/debian/" rel="tag">debian</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java11/" rel="tag">java11</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/juc/" rel="tag">juc</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">jvm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/keil/" rel="tag">keil</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proteus/" rel="tag">proteus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssb/" rel="tag">ssb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssm/" rel="tag">ssm</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/debian/" style="font-size: 13.5px;">debian</a> <a href="/tags/java/" style="font-size: 14px;">java</a> <a href="/tags/java11/" style="font-size: 13px;">java11</a> <a href="/tags/juc/" style="font-size: 13.5px;">juc</a> <a href="/tags/jvm/" style="font-size: 13.5px;">jvm</a> <a href="/tags/kafka/" style="font-size: 13px;">kafka</a> <a href="/tags/keil/" style="font-size: 13px;">keil</a> <a href="/tags/mysql/" style="font-size: 13px;">mysql</a> <a href="/tags/nginx/" style="font-size: 13px;">nginx</a> <a href="/tags/proteus/" style="font-size: 13px;">proteus</a> <a href="/tags/redis/" style="font-size: 13px;">redis</a> <a href="/tags/ssb/" style="font-size: 13px;">ssb</a> <a href="/tags/ssm/" style="font-size: 13px;">ssm</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/kafka/">kafka</a>
              </p>
              <p class="item-title">
                <a href="/2023/03/09/kafka/" class="title">Kafka</a>
              </p>
              <p class="item-date">
                <time datetime="2023-03-09T10:19:44.444Z" itemprop="datePublished">2023-03-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/java/">java</a>
              </p>
              <p class="item-title">
                <a href="/2023/03/07/%E5%9F%BA%E7%A1%80/" class="title">基础</a>
              </p>
              <p class="item-date">
                <time datetime="2023-03-07T10:42:48.718Z" itemprop="datePublished">2023-03-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/redis/">redis</a>
              </p>
              <p class="item-title">
                <a href="/2023/02/17/redis/" class="title">redis</a>
              </p>
              <p class="item-date">
                <time datetime="2023-02-17T13:22:50.541Z" itemprop="datePublished">2023-02-17</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/mysql/">mysql</a>
              </p>
              <p class="item-title">
                <a href="/2023/02/17/mysql/" class="title">mysql</a>
              </p>
              <p class="item-date">
                <time datetime="2023-02-17T13:21:00.159Z" itemprop="datePublished">2023-02-17</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/java/">java</a>
              </p>
              <p class="item-title">
                <a href="/2023/02/17/ssb/" class="title">ssb</a>
              </p>
              <p class="item-date">
                <time datetime="2023-02-17T13:19:19.502Z" itemprop="datePublished">2023-02-17</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">Catalogue</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#kafka"><span class="toc-number">1.</span> <span class="toc-text"> Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text"> Kafka架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka%E4%BC%98%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text"> Kafka优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text"> 主要组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#broker"><span class="toc-number">1.3.1.</span> <span class="toc-text"> broker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#topic%E4%B8%BB%E9%A2%98"><span class="toc-number">1.3.2.</span> <span class="toc-text"> topic（主题）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#partition%E5%88%86%E5%8C%BA"><span class="toc-number">1.3.3.</span> <span class="toc-text"> partition（分区）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#offset"><span class="toc-number">1.3.4.</span> <span class="toc-text"> offset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#producer%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">1.3.5.</span> <span class="toc-text"> producer（生产者）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#consumer%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.3.6.</span> <span class="toc-text"> consumer（消费者）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#consumer-group%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-number">1.3.7.</span> <span class="toc-text"> consumer group（消费者组）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#partition-replicas%E5%88%86%E5%8C%BA%E5%89%AF%E6%9C%AC"><span class="toc-number">1.3.8.</span> <span class="toc-text"> partition replicas（分区副本）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#segment%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.9.</span> <span class="toc-text"> segment文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#message%E7%89%A9%E7%90%86%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.10.</span> <span class="toc-text"> message物理结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zookeeper"><span class="toc-number">1.3.11.</span> <span class="toc-text"> zookeeper</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92"><span class="toc-number">1.4.</span> <span class="toc-text"> 消息传递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E5%AF%B9%E7%82%B9%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 点对点消息传递模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 发布-订阅消息传递模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text"> 服务治理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 数据同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isr"><span class="toc-number">1.5.2.</span> <span class="toc-text"> ISR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kafka%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="toc-number">1.5.3.</span> <span class="toc-text"> Kafka故障恢复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E5%A4%B1%E6%9C%BA%E5%88%B6"><span class="toc-number">1.6.</span> <span class="toc-text"> 数据不丢失机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%94%9F%E4%BA%A7%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E5%A4%B1"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 生产者生产数据不丢失</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#broker%E4%B8%AD%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E5%A4%B1"><span class="toc-number">1.6.2.</span> <span class="toc-text"> broker中数据不丢失</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%B6%88%E8%B4%B9%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E5%A4%B1"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 消费者消费数据不丢失</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.</span> <span class="toc-text"> 常见问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kafka"><span class="toc-number">1.8.</span> <span class="toc-text"> 安装Kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-boot%E6%A1%88%E4%BE%8B"><span class="toc-number">1.9.</span> <span class="toc-text"> Spring Boot案例</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-kafka" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kafka
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2023/03/09/kafka/" class="article-date">
	  <time datetime="2023-03-09T10:19:44.444Z" itemprop="datePublished">2023-03-09</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/kafka/">kafka</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/kafka/" rel="tag">kafka</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/03/09/kafka/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="kafka"><a class="markdownIt-Anchor" href="#kafka"></a> Kafka</h2>
<p>Kafka是最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式日志系统（也可以当做MQ系统），常见可以用于web/nginx日志、访问日志，消息服务等等，Linkedin于2010年贡献给了Apache基金会并成为顶级开源项目。主要应用场景是：日志收集系统和消息系统。Kafka主要设计目标如下：</p>
<ul>
<li>以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间的访问性能</li>
<li>高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条消息的传输</li>
<li>支持Kafka Server间的消息分区，及分布式消费，同时保证每个partition内的消息顺序传输</li>
<li>同时支持离线数据处理和实时数据处理</li>
<li>Scale out:支持在线水平扩展</li>
</ul>
<p>消息传递模式：<strong>点对点传递模式、发布-订阅模式</strong>。大部分消息系统选用发布-订阅模式。<strong>Kafka就是一种发布-订阅模式</strong>。</p>
<h3 id="kafka架构"><a class="markdownIt-Anchor" href="#kafka架构"></a> Kafka架构</h3>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9E%B6%E6%9E%84.png" alt="Kafka架构"></p>
<p>kafka支持消息持久化，消费端是主动拉取数据，消费状态和订阅关系由客户端负责维护，<strong>消息消费完后，不会立即删除，会保留历史消息</strong>。因此支持多订阅时，消息只会存储一份就可以。</p>
<ul>
<li><strong>broker</strong>：kafka集群中包含一个或者多个服务实例（节点），这种服务实例被称为broker（一个broker就是一个节点/一个服务器）</li>
<li><strong>topic</strong>：每条发布到kafka集群的消息都属于某个类别，这个类别就叫做topic</li>
<li><strong>partition</strong>：partition是一个物理上的概念，每个topic包含一个或者多个partition</li>
<li><strong>segment</strong>：一个partition当中存在多个segment文件段，每个segment分为两部分，.log文件和 .index 文件，其中 .index 文件是索引文件，主要用于快速查询， .log 文件当中数据的偏移量位置</li>
<li><strong>producer</strong>：消息的生产者，负责发布消息到 kafka 的 broker 中</li>
<li><strong>consumer</strong>：消息的消费者，向 kafka 的 broker 中读取消息的客户端</li>
<li><strong>consumer group</strong>：消费者组，每一个 consumer 属于一个特定的 consumer group（可以为每个consumer指定 groupName）</li>
<li><strong>.log</strong>：存放数据文件</li>
<li><strong>.index</strong>：存放.log文件的索引数据</li>
</ul>
<h3 id="kafka优点"><a class="markdownIt-Anchor" href="#kafka优点"></a> Kafka优点</h3>
<ul>
<li>
<p><strong>解耦</strong></p>
<p>在项目启动之初来预测将来项目会碰到什么需求，是极其困难的。消息系统在处理过程中间插入了一个隐含的、基于数据的接口层，两边的处理过程都要实现这一接口。这允许你独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束。</p>
</li>
<li>
<p><strong>冗余（副本）</strong></p>
<p>有些情况下，处理数据的过程会失败。除非数据被持久化，否则将造成丢失。消息队列把数据进行持久化直到它们已经被完全处理，通过这一方式规避了数据丢失风险。许多消息队列所采用的&quot;插入-获取-删除&quot;范式中，在把一个消息从队列中删除之前，需要你的处理系统明确的指出该消息已经被处理完毕，从而确保你的数据被安全的保存直到你使用完毕。</p>
</li>
<li>
<p><strong>扩展性</strong></p>
<p>因为消息队列解耦了你的处理过程，所以增大消息入队和处理的频率是很容易的，只要另外增加处理过程即可。不需要改变代码、不需要调节参数。扩展就像调大电力按钮一样简单。</p>
</li>
<li>
<p><strong>灵活性&amp;峰值处理能力</strong></p>
<p>在访问量剧增的情况下，应用仍然需要继续发挥作用，但是这样的突发流量并不常见；如果为以能处理这类峰值访问为标准来投入资源随时待命无疑是巨大的浪费。使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而完全崩溃。</p>
</li>
<li>
<p><strong>可恢复性</strong></p>
<p>系统的一部分组件失效时，不会影响到整个系统。消息队列降低了进程间的耦合度，所以即使一个处理消息的进程挂掉，加入队列中的消息仍然可以在系统恢复后被处理。</p>
</li>
<li>
<p><strong>顺序保证</strong></p>
<p>在大多使用场景下，数据处理的顺序都很重要。大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来处理。Kafka保证一个Partition内的消息的有序性。</p>
</li>
<li>
<p><strong>缓冲</strong></p>
<p>在任何重要的系统中，都会有需要不同的处理时间的元素。例如，加载一张图片比应用过滤器花费更少的时间。消息队列通过一个缓冲层来帮助任务最高效率的执行———写入队列的处理会尽可能的快速。该缓冲有助于控制和优化数据流经过系统的速度。</p>
</li>
<li>
<p><strong>异步通信</strong></p>
<p>很多时候，用户不想也不需要立即处理消息。消息队列提供了异步处理机制，允许用户把一个消息放入队列，但并不立即处理它。想向队列中放入多少消息就放多少，然后在需要的时候再去处理它们。</p>
</li>
</ul>
<h3 id="主要组件"><a class="markdownIt-Anchor" href="#主要组件"></a> 主要组件</h3>
<h4 id="broker"><a class="markdownIt-Anchor" href="#broker"></a> broker</h4>
<p>Kafka 服务器，负责消息存储和转发；一个 broker 就代表一个 kafka 节点。<strong>一个 broker 可以包含多个 topic</strong>。</p>
<h4 id="topic主题"><a class="markdownIt-Anchor" href="#topic主题"></a> topic（主题）</h4>
<ul>
<li>kafka将消息以topic为单位进行归类</li>
<li>topic特指kafka处理的消息源（feeds of messages）的不同分类</li>
<li>topic是一种分类或者发布的一些列记录的名义上的名字。kafka主题始终是支持多用户订阅的；也就是说，一 个主题可以有零个，一个或者多个消费者订阅写入的数据</li>
<li>在kafka集群中，可以有无数的主题</li>
<li>生产者和消费者消费数据一般以主题为单位。更细粒度可以到分区级别</li>
</ul>
<p>kafka学习了数据库里面的设计，在里面设计了topic（主题），这个东西类似于关系型数据库的表</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-topic.jpg" alt="kafka-topic"></p>
<p>此时我需要获取数据，那就直接监听TopicA即可。</p>
<h4 id="partition分区"><a class="markdownIt-Anchor" href="#partition分区"></a> partition（分区）</h4>
<p>kafka当中，topic是消息的归类，一个topic可以有多个分区（partition），每个分区保存部分topic的数据，所有的partition当中的数据全部合并起来，就是一个topic当中的所有的数据。一个broker服务下，可以创建多个分区，broker数与分区数没有关系； 在kafka中，每一个分区会有一个编号：编号从0开始。<strong>每一个分区内的数据是有序的，但全局的数据不能保证是有序的。</strong>（有序是指生产什么样顺序，消费时也是什么样的顺序）</p>
<p>kafka还有一个概念叫Partition（分区），分区具体在服务器上面表现起初就是一个目录，一个主题下面有多个分区，这些分区会存储到不同的服务器上面，或者说，其实就是在不同的主机上建了不同的目录。这些分区主要的信息就存在了.log文件里面。跟数据库里面的分区差不多，是为了提高性能。</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-partition.jpg" alt="kafka-partition"></p>
<p>至于为什么提高了性能，很简单，多个分区多个线程，多个线程并行处理肯定会比单线程好得多</p>
<p>Topic和partition像是HBASE里的table和region的概念，table只是一个逻辑上的概念，真正存储数据的是region，这些region会分布式地存储在各个服务器上面，对应于kafka，也是一样，<strong>Topic也是逻辑概念</strong>，而partition就是分布式存储单元。这个设计是保证了海量数据处理的基础。我们可以对比一下，如果HDFS没有block的设计，一个100T的文件也只能单独放在一个服务器上面，那就直接占满整个服务器了，引入block后，大文件可以分散存储在不同的服务器上。</p>
<p>注意：</p>
<p>1.分区会有单点故障问题，所以我们会为每个分区设置副本数</p>
<p>2.分区的编号是从0开始的</p>
<p>topic 的分区，一个 topic 可以包含多个 partition，topic 消息保存在各个 partition 上；由于一个 topic 能被分到多个分区上，给 kafka 提供给了并行的处理能力，这也正是 kafka 高吞吐的原因之一。</p>
<p>partition 物理上由多个 segment 文件组成，每个 segment 大小相等，<strong>顺序读写（这也是 kafka 比较快的原因之一，不需要随机写）</strong>。每个 Segment 数据文件以该段中最小的 offset ，文件扩展名为.log。当查找 offset 的 Message 的时候，通过二分查找快找到 Message 所处于的 Segment 中。</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-partition.png" alt="kafka-partition"></p>
<h4 id="offset"><a class="markdownIt-Anchor" href="#offset"></a> offset</h4>
<ul>
<li>消息在日志中的位置，可以理解是消息在 partition 上的偏移量，也是代表该消息的<strong>唯一序号</strong>。</li>
<li>同时也是主从之间的需要同步的信息</li>
</ul>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-offset.png" alt="kafka-offset"></p>
<h4 id="producer生产者"><a class="markdownIt-Anchor" href="#producer生产者"></a> producer（生产者）</h4>
<p>producer主要是用于生产消息，是kafka当中的消息生产者，生产的消息通过topic进行归类，保存到kafka的broker里面。往消息系统里面发送数据的就是生产者。</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-producer.jpg" alt="kafka-producer"></p>
<h4 id="consumer消费者"><a class="markdownIt-Anchor" href="#consumer消费者"></a> consumer（消费者）</h4>
<p>consumer是kafka当中的消费者，主要用于消费kafka当中的数据，消费者一定是归属于某个消费组中的。从kafka里读取数据的就是消费者：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-consume.jpg" alt="kafka-consumer"></p>
<h4 id="consumer-group消费者组"><a class="markdownIt-Anchor" href="#consumer-group消费者组"></a> consumer group（消费者组）</h4>
<p>消费者组由一个或者多个消费者组成，<strong>同一个组中的消费者对于同一条消息只消费一次</strong>。每个消费者都属于某个消费者组，如果不指定，那么所有的消费者都属于默认的组。每个消费者组都有一个ID，即group ID。组内的所有消费者协调在一起来消费一个订阅主题( topic)的所有分区(partition)。当然，<strong>每个分区只能由同一个消费组内的一个消费者(consumer)来消费</strong>，可以由不同的<strong>消费组</strong>来消费。partition数量决定了每个consumer group中并发消费者的最大数量。如下图：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/consumer_group%E7%A4%BA%E4%BE%8B.png" alt="consumer_group示例"></p>
<p>如上面左图所示，如果只有两个分区，即使一个组内的消费者有4个，也会有两个空闲的。如上面右图所示，有4个分区，每个消费者消费一个分区，并发量达到最大4。在来看如下一幅图：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/consumer_group%E7%A4%BA%E4%BE%8B2.png" alt="consumer_group示例2"></p>
<p>如上图所示，不同的消费者组消费同一个topic，这个topic有4个分区，分布在两个节点上。左边的 消费组1有两个消费者，每个消费者就要消费两个分区才能把消息完整的消费完，右边的 消费组2有四个消费者，每个消费者消费一个分区即可。</p>
<p><strong>总结下kafka中分区与消费组的关系</strong>：</p>
<p>消费组：由一个或者多个消费者组成，同一个组中的消费者对于同一条消息只消费一次。</p>
<p>某一个主题下的分区数，对于消费该主题的同一个消费组下的消费者数量，应该小于等于该主题下的分区数。</p>
<p>如：某一个主题有4个分区，那么消费组中的消费者应该小于等于4，而且最好与分区数成整数倍 1 2 4 这样。同一个分区下的数据，在同一时刻，不能同一个消费组的不同消费者消费。</p>
<p>总结：<strong>分区数越多，同一时间可以有越多的消费者来进行消费，消费数据的速度就会越快，提高消费的性能</strong>。</p>
<h4 id="partition-replicas分区副本"><a class="markdownIt-Anchor" href="#partition-replicas分区副本"></a> partition replicas（分区副本）</h4>
<p>kafka 中的分区副本如下图所示：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka%E5%88%86%E5%8C%BA%E5%89%AF%E6%9C%AC.png" alt="kafka分区副本"></p>
<p><strong>副本数</strong>（replication-factor）：控制消息保存在几个broker（服务器）上，一般情况下副本数等于broker的个数。</p>
<p>一个broker服务下，不可以创建多个副本因子。<strong>创建主题时，副本因子应该小于等于可用的broker数</strong>。副本因子操作以分区为单位的。每个分区都有各自的主副本和从副本；主副本叫做leader，从副本叫做 follower（在有多个副本的情况下，kafka会为同一个分区下的所有分区，设定角色关系：一个leader和N个 follower），<strong>处于同步状态的副本叫做in-sync-replicas(ISR)</strong>。</p>
<h4 id="segment文件"><a class="markdownIt-Anchor" href="#segment文件"></a> segment文件</h4>
<p>一个partition当中由多个segment文件组成，每个segment文件，包含两部分，一个是 .log 文件，另外一个是 .index 文件，其中 .log 文件包含了我们发送的数据存储，.index 文件，记录的是我们.log文件的数据索引值，便于我们加快数据查询速度。</p>
<h4 id="message物理结构"><a class="markdownIt-Anchor" href="#message物理结构"></a> message物理结构</h4>
<p>生产者发送到kafka的每条消息，都被kafka包装成了一个message。message 的物理结构如下图所示：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/message%E7%89%A9%E7%90%86%E7%BB%93%E6%9E%84.png" alt="message物理结构"></p>
<p>所以生产者发送给kafka的消息并不是直接存储起来，而是经过kafka的包装，每条消息都是上图这个结构，只有最后一个字段才是真正生产者发送的消息数据。</p>
<h4 id="zookeeper"><a class="markdownIt-Anchor" href="#zookeeper"></a> zookeeper</h4>
<p>管理 kafka 集群，负责存储了集群 broker、topic、partition 等 meta 数据存储，同时也负责 broker 故障发现，partition leader 选举，负载均衡等功能。</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-zookeeper.png" alt="kafka-zookeeper"></p>
<h3 id="消息传递"><a class="markdownIt-Anchor" href="#消息传递"></a> 消息传递</h3>
<h4 id="点对点消息传递模式"><a class="markdownIt-Anchor" href="#点对点消息传递模式"></a> 点对点消息传递模式</h4>
<p>在点对点消息系统中，消息持久化到一个队列中。此时，将有一个或多个消费者消费队列中的数据。但是一条消息只能被消费一次。当一个消费者消费了队列中的某条数据之后，该条数据则从消息队列中删除。该模式即使有多个消费者同时消费数据，也能保证数据处理的顺序。这种架构描述示意图如下：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E7%82%B9%E5%AF%B9%E7%82%B9%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%A8%A1%E5%BC%8F.png" alt="Kafka点对点消息传递模式"></p>
<p><strong>生产者发送一条消息到queue，只有一个消费者能收到</strong>。</p>
<h4 id="发布-订阅消息传递模式"><a class="markdownIt-Anchor" href="#发布-订阅消息传递模式"></a> 发布-订阅消息传递模式</h4>
<p>在发布-订阅消息系统中，消息被持久化到一个topic中。与点对点消息系统不同的是，消费者可以订阅一个或多个topic，消费者可以消费该topic中所有的数据，同一条数据可以被多个消费者消费，数据被消费后不会立马删除。在发布-订阅消息系统中，消息的生产者称为发布者，消费者称为订阅者。该模式的示例图如下：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%E6%A8%A1%E5%BC%8F.png" alt="Kafka发布-订阅消息传递模式"></p>
<p><strong>发布者发送到topic的消息，只有订阅了topic的订阅者才会收到消息</strong>。</p>
<h3 id="服务治理"><a class="markdownIt-Anchor" href="#服务治理"></a> 服务治理</h3>
<p>既然 Kafka 是分布式的发布/订阅系统，这样如果做的集群之间数据同步和一致性，kafka 是不是肯定不会丢消息呢？以及宕机的时候如果进行 Leader 选举呢？</p>
<h4 id="数据同步"><a class="markdownIt-Anchor" href="#数据同步"></a> 数据同步</h4>
<p>在 Kafka 中的 Partition 有一个 leader 与多个 follower，producer 往某个 Partition 中写入数据是，只会往 leader 中写入数据，然后数据才会被复制进其他的 Replica 中。而每一个 follower 可以理解成一个消费者，定期去 leader 去拉去消息。而只有数据同步了后，kafka 才会给生产者返回一个 ACK 告知消息已经存储落地了。</p>
<h4 id="isr"><a class="markdownIt-Anchor" href="#isr"></a> ISR</h4>
<p>在 Kafka 中，为了保证性能，Kafka 不会采用强一致性的方式来同步主从的数据。而是维护了一个：in-sync Replica 的列表，Leader 不需要等待所有 Follower 都完成同步，只要在 ISR 中的 Follower 完成数据同步就可以发送 ack 给生产者即可认为消息同步完成。同时如果发现 ISR 里面某一个 follower 落后太多的话，就会把它剔除。</p>
<p>具体流程如下：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-ISR-1.png" alt="Kafka服务治理-ISR-1"></p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-ISR-2.png" alt="Kafka服务治理-ISR-2"></p>
<p><img src="/2023/03/09/kafka/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAAAAACIM/FCAAACh0lEQVR4Ae3ch5W0OgyG4dt/mQJ2xgQPzJoM1m3AbALrxzrf28FzsoP0HykJEEAAAUQTBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEkKK0789+GK/I2ezfQB522PnS1qc8pGgXvr4tE4aY0XOUWlGImThWgyCk6DleixzE7qwBkg/MGiDPlVVAyp1VQGrPKiACDhFI6VkF5LmzCki+sg7IwDoglnVAil0IMkeG9CyUiwsxLFUVFzJJOQaKCjFCDN9RXMjIX7W6ztZXZDKKCyn8sWJvH+nca7WHDN9lROlAliPH9iRKCPI4cswFJQWxB46toLQgQ9jhn5QYZA9DOkoMUoQde5YapAxDWkoNYsOQR3KQd9CxUnIQF4S49CB9ENKlBxmDEKsFUgMCCCCAAHIrSF61f6153Ajy8nyiPr8L5MXnmm4CyT2fzN4DUvHZ+ntA2tOQBRBAAAEEEEAAAQQQ7ZBaC6TwSiDUaYHQ2yuB0MN+ft+43whyrs4rgVCjBUKTFshLC6TUAjGA3AxSaYFYLZBOC2RUAsk8h5qTg9QcbEoOsoQhQ2qQhsO5xCD5dgB5JQaZ+KBKGtKecvR81Ic0ZDjByKdDx0rSEDZ/djQbH+bkIdvfJFm98BfV8hD2zprfVdlu9PxVeyYAkciREohRAplJCaRSAplJCcQogTjSAdlyHRBvSAekJR0QRzogA+mADJkOiCPSAPEtqYBshlRAXC43hxix2QiOuEZkVERykGyNo9idIZKE0HO7XrG6OiMShlDWjstVzdPgXtUH9v0CEidAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQP4HgjZxTpdEii0AAAAASUVORK5CYII=" alt="Kafka服务治理-ISR-3"></p>
<p><img src="/2023/03/09/kafka/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAAAAACIM/FCAAACh0lEQVR4Ae3ch5W0OgyG4dt/mQJ2xgQPzJoM1m3AbALrxzrf28FzsoP0HykJEEAAAUQTBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEkKK0789+GK/I2ezfQB522PnS1qc8pGgXvr4tE4aY0XOUWlGImThWgyCk6DleixzE7qwBkg/MGiDPlVVAyp1VQGrPKiACDhFI6VkF5LmzCki+sg7IwDoglnVAil0IMkeG9CyUiwsxLFUVFzJJOQaKCjFCDN9RXMjIX7W6ztZXZDKKCyn8sWJvH+nca7WHDN9lROlAliPH9iRKCPI4cswFJQWxB46toLQgQ9jhn5QYZA9DOkoMUoQde5YapAxDWkoNYsOQR3KQd9CxUnIQF4S49CB9ENKlBxmDEKsFUgMCCCCAAHIrSF61f6153Ajy8nyiPr8L5MXnmm4CyT2fzN4DUvHZ+ntA2tOQBRBAAAEEEEAAAQQQ7ZBaC6TwSiDUaYHQ2yuB0MN+ft+43whyrs4rgVCjBUKTFshLC6TUAjGA3AxSaYFYLZBOC2RUAsk8h5qTg9QcbEoOsoQhQ2qQhsO5xCD5dgB5JQaZ+KBKGtKecvR81Ic0ZDjByKdDx0rSEDZ/djQbH+bkIdvfJFm98BfV8hD2zprfVdlu9PxVeyYAkciREohRAplJCaRSAplJCcQogTjSAdlyHRBvSAekJR0QRzogA+mADJkOiCPSAPEtqYBshlRAXC43hxix2QiOuEZkVERykGyNo9idIZKE0HO7XrG6OiMShlDWjstVzdPgXtUH9v0CEidAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEEEAAAQQQQP4HgjZxTpdEii0AAAAASUVORK5CYII=" alt="Kafka服务治理-ISR-4"></p>
<p>**上述的做法并无法保证 kafka 一定不丢消息。**虽然 Kafka 通过多副本机制中最大限度保证消息不会丢失，但是如果数据已经写入系统 page cache 中但是还没来得及刷入磁盘，此时突然机器宕机或者掉电，那消息自然而然的就会丢失。</p>
<h4 id="kafka故障恢复"><a class="markdownIt-Anchor" href="#kafka故障恢复"></a> Kafka故障恢复</h4>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D.png" alt="Kafka服务治理-故障恢复"></p>
<p>Kafka 通过 Zookeeper 连坐集群的管理，所以这里的选举机制采用的是 Zab(zookeeper 使用)。</p>
<ul>
<li>生产者发生消息给 leader，这个时候 leader 完成数据存储，突然发生故障，没有给 producer 返回 ack</li>
<li>通过 ZK 选举，其中一个 follower 成为 leader，这个时候 producer 重新请求新的 leader，并存储数据</li>
</ul>
<h3 id="数据不丢失机制"><a class="markdownIt-Anchor" href="#数据不丢失机制"></a> 数据不丢失机制</h3>
<h4 id="生产者生产数据不丢失"><a class="markdownIt-Anchor" href="#生产者生产数据不丢失"></a> 生产者生产数据不丢失</h4>
<p><strong>发送消息方式</strong></p>
<p>生产者发送给kafka数据，可以采用<strong>同步方式</strong>或<strong>异步方式</strong>：</p>
<ul>
<li>
<p><strong>同步方式</strong></p>
<p>发送一批数据给kafka后，等待kafka返回结果：</p>
<ul>
<li>生产者等待10s，如果broker没有给出ack响应，就认为失败</li>
<li>生产者重试3次，如果还没有响应，就报错</li>
</ul>
</li>
<li>
<p><strong>异步方式</strong></p>
<p>发送一批数据给kafka，只是提供一个回调函数：</p>
<ul>
<li>先将数据保存在生产者端的buffer中。buffer大小是2万条</li>
<li>满足数据阈值或者数量阈值其中的一个条件就可以发送数据</li>
<li>发送一批数据的大小是500条</li>
</ul>
</li>
</ul>
<p>注意：如果broker迟迟不给ack，而buffer又满了，开发者可以设置是否直接清空buffer中的数据。</p>
<p><strong>ack机制（确认机制）</strong></p>
<p>生产者数据发送出去，需要服务端返回一个确认码，即ack响应码；ack的响应有三个状态值：</p>
<ul>
<li>0：生产者只负责发送数据，不关心数据是否丢失，丢失的数据，需要再次发送</li>
<li>1：partition的leader收到数据，不管follow是否同步完数据，响应的状态码为1</li>
<li>-1：所有的从节点都收到数据，响应的状态码为-1</li>
</ul>
<p><strong>注意</strong>：如果broker端一直不返回ack状态，producer永远不知道是否成功；producer可以设置一个超时时间10s，超过时间认为失败。</p>
<h4 id="broker中数据不丢失"><a class="markdownIt-Anchor" href="#broker中数据不丢失"></a> broker中数据不丢失</h4>
<p>在broker中，保证数据不丢失主要是通过副本因子（冗余），防止数据丢失。</p>
<h4 id="消费者消费数据不丢失"><a class="markdownIt-Anchor" href="#消费者消费数据不丢失"></a> 消费者消费数据不丢失</h4>
<p>在消费者消费数据的时候，只要每个消费者记录好offset值即可，就能保证数据不丢失。也就是需要我们自己维护偏移量(offset)，可保存在 Redis 中。</p>
<h3 id="常见问题"><a class="markdownIt-Anchor" href="#常见问题"></a> 常见问题</h3>
<p><strong>问题一：Kafka性能好在什么地方？</strong></p>
<ul>
<li>
<p><strong>顺序写磁盘</strong></p>
<p>操作系统每次从磁盘读写数据的时候，需要先寻址，也就是先要找到数据在磁盘上的物理位置，然后再进行数据读写，如果是机械硬盘，寻址就需要较长的时间。 kafka的设计中，数据其实是存储在磁盘上面，一般来说，会把数据存储在内存上面性能才会好。但是kafka用的是顺序写，追加数据是追加到末尾，磁盘顺序写的性能极高，在磁盘个数一定，转数达到一定的情况下，基本和内存速度一致。随机写的话是在文件的某个位置修改数据，性能会较低。</p>
</li>
<li>
<p><strong>Page Cache</strong></p>
<p>Kafka 在 OS 系统方面使用了 Page Cache 而不是我们平常所用的 Buffer。Page Cache 其实不陌生，也不是什么新鲜事物</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka-PageCache.png" alt="Kafka-PageCache"></p>
<p>我们在 linux 上查看内存的时候，经常可以看到 buff/cache，两者都是用来加速 IO 读写用的，而 cache 是作用于读，也就是说，磁盘的内容可以读到 cache 里面这样，应用程序读磁盘就非常快；而 buff 是作用于写，我们开发写磁盘都是，一般如果写入一个 buff 里面再 flush 就非常快。而 kafka 正是把这两者发挥了极致：</p>
<p>Kafka 虽然是 scala 写的，但是依旧在 Java 的虚拟机上运行，尽管如此，它尽量避开了 JVM 的限制，它利用了 Page cache 来存储，这样躲开了数据在 JVM 因为 GC 而发生的 STD。另一方面也是 Page Cache 使得它实现了零拷贝，具体下面会讲。</p>
</li>
<li>
<p><strong>零拷贝</strong></p>
<p>先来看看非零拷贝的情况：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D.jpg" alt="kafka-零拷贝"></p>
<p>可以看到数据的拷贝从内存拷贝到kafka服务进程那块，又拷贝到socket缓存那块，整个过程耗费的时间比较高，kafka利用了Linux的sendFile技术（NIO），省去了进程切换和一次数据拷贝，让性能变得更好。</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BC%98%E5%8C%96.jpg" alt="kafka-零拷贝优化"></p>
<p><strong>传统的一次应用程请求数据的过程</strong></p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82.png" alt="kafka-传统数据请求"></p>
<p>这里大致可以发传统的方式发生了 4 次拷贝，2 次 DMA 和 2 次 CPU，而 CPU 发生了 4 次的切换。（DMA 简单理解就是，在进行 I/O 设备和内存的数据传输的时候，数据搬运的工作全部交给 DMA 控制器，而 CPU 不再参与任何与数据搬运相关的事情）</p>
<p><strong>零拷贝的方式</strong></p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%9A%84%E6%96%B9%E5%BC%8F.png" alt="kafka-零拷贝的方式"></p>
<p>通过优化我们可以发现，CPU 只发生了 2 次的上下文切换和 3 次数据拷贝。（linux 系统提供了系统事故调用函数“ sendfile()”，这样系统调用，可以直接把内核缓冲区里的数据拷贝到 socket 缓冲区里，不再拷贝到用户态）</p>
</li>
<li>
<p><strong>分区分段</strong></p>
<p>我们上面也介绍过了，kafka 采取了分区的模式，而每一个分区又对应到一个物理分段，而查找的时候可以根据二分查找快速定位。这样不仅提供了数据读的查询效率，也提供了并行操作的方式。</p>
</li>
<li>
<p><strong>数据压缩</strong></p>
<p>Kafka 对数据提供了：Gzip 和 Snappy 压缩协议等压缩协议，对消息结构体进行了压缩，一方面减少了带宽，也减少了数据传输的消耗。</p>
</li>
</ul>
<p><strong>问题二：日志如何分段存储？</strong></p>
<p>Kafka规定了一个分区内的.log文件最大为1G，做这个限制目的是为了方便把.log加载到内存去操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00000000000000000000.index</span><br><span class="line">00000000000000000000.log</span><br><span class="line">00000000000000000000.timeindex</span><br><span class="line"></span><br><span class="line">00000000000005367851.index</span><br><span class="line">00000000000005367851.log</span><br><span class="line">00000000000005367851.timeindex</span><br><span class="line"></span><br><span class="line">00000000000009936472.index</span><br><span class="line">00000000000009936472.log</span><br><span class="line">00000000000009936472.timeindex</span><br></pre></td></tr></table></figure>
<p>这个9936472之类的数字，就是代表了这个日志段文件里包含的起始offset，也就说明这个分区里至少都写入了接近1000万条数据了。Kafka broker有一个参数，log.segment.bytes，限定了每个日志段文件的大小，最大就是1GB，一个日志段文件满了，就自动开一个新的日志段文件来写入，避免单个文件过大，影响文件的读写性能，这个过程叫做log rolling，正在被写入的那个日志段文件，叫做active log segment。如果大家有看前面的两篇有关于HDFS的文章时，就会发现NameNode的edits log也会做出限制，所以这些框架都是会考虑到这些问题。</p>
<p><strong>问题三：Kafka如何网络设计？</strong></p>
<p>kafka的网络设计和Kafka的调优有关，这也是为什么它能支持高并发的原因：</p>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/Kafka%E7%9A%84%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1.jpg" alt="Kafka的网络设计"></p>
<p>首先客户端发送请求全部会先发送给一个Acceptor，broker里面会存在3个线程（默认是3个），这3个线程都是叫做processor，Acceptor不会对客户端的请求做任何的处理，直接封装成一个个socketChannel发送给这些processor形成一个队列，发送的方式是轮询，就是先给第一个processor发送，然后再给第二个，第三个，然后又回到第一个。消费者线程去消费这些socketChannel时，会获取一个个request请求，这些request请求中就会伴随着数据。</p>
<p>线程池里面默认有8个线程，这些线程是用来处理request的，解析请求，如果request是写请求，就写到磁盘里。读的话返回结果。 processor会从response中读取响应数据，然后再返回给客户端。这就是Kafka的网络三层架构。</p>
<p>所以如果我们需要对kafka进行增强调优，增加processor并增加线程池里面的处理线程，就可以达到效果。request和response那一块部分其实就是起到了一个缓存的效果，是考虑到processor们生成请求太快，线程数不够不能及时处理的问题。所以这就是一个加强版的reactor网络线程模型。</p>
<h3 id="安装kafka"><a class="markdownIt-Anchor" href="#安装kafka"></a> 安装Kafka</h3>
<p>第一步：安装 JDK</p>
<p>第二步：安装 Zookeeper</p>
<p>第三步：下载Kafka：<a href="https://gitee.com/link?target=https%3A%2F%2Fwww.apache.org%2Fdyn%2Fcloser.cgi%3Fpath%3D%2Fkafka%2F2.8.0%2Fkafka-2.8.0-src.tgz">https://www.apache.org/dyn/closer.cgi?path=/kafka/2.8.0/kafka-2.8.0-src.tgz</a></p>
<p>第四步：安装Kafka：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf kafka_2.12-2.0.0.tgz </span><br></pre></td></tr></table></figure>
<p>第五步：配置环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> export ZK=/usr/local/src/apache-zookeeper-3.7.0-bin</span><br><span class="line">export PATH=$PATH:$ZK/bin</span><br><span class="line">export KAFKA=/usr/local/src/kafka</span><br><span class="line">export PATH=$PATH:$KAFKA/bin</span><br></pre></td></tr></table></figure>
<p>第六步：启动Kafka：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup kafka-server-start.sh 自己的配置文件路径/server.properties &amp;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yu120/lemon-guide/raw/main/images/BigData/%E5%90%AF%E5%8A%A8Kafka%E6%97%A5%E5%BF%97.png" alt="启动Kafka日志"></p>
<h3 id="spring-boot案例"><a class="markdownIt-Anchor" href="#spring-boot案例"></a> Spring Boot案例</h3>
<p>第一步：添加依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>第二步：配置文件application.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kafka:</span><br><span class="line">    bootstrap:</span><br><span class="line">        servers: localhost:9092</span><br><span class="line">    topic:</span><br><span class="line">        user: topic-user</span><br><span class="line">    group:</span><br><span class="line">        id: group-user</span><br></pre></td></tr></table></figure>
<p>第三步：创建kafka生产者类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Kafka消息生产类</span><br><span class="line"> */</span><br><span class="line">@Log</span><br><span class="line">@Component</span><br><span class="line">public class KafkaProducer &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    @Value(&quot;$&#123;kafka.topic.user&#125;&quot;)</span><br><span class="line">    private String topicUser;// topic名称</span><br><span class="line">    /**</span><br><span class="line">     * 发送用户消息</span><br><span class="line">     * @param user 用户信息</span><br><span class="line">     */</span><br><span class="line">    public void sendUserMessage(User user) &#123;</span><br><span class="line">        GsonBuilder builder = new GsonBuilder();</span><br><span class="line">        builder.setPrettyPrinting();</span><br><span class="line">        builder.setDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">        String message = builder.create().toJson(user);</span><br><span class="line">        kafkaTemplate.send(topicUser, message);</span><br><span class="line">        log.info(&quot;\n生产消息至Kafka\n&quot; + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 测试控制器</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/kafka&quot;)</span><br><span class="line">public class KafkaController &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private User user;</span><br><span class="line">    @Autowired</span><br><span class="line">    private KafkaProducer kafkaProducer;</span><br><span class="line">    @RequestMapping(&quot;/createMsg&quot;)</span><br><span class="line">    public void createMsg() &#123;</span><br><span class="line">        kafkaProducer.sendUserMessage(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第四步：创建kafka消费者类，并通过控制器调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class KafkaConsumerDemo &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;kafka.topic.user&#125;&quot;)</span><br><span class="line">    private String topicUser;// topic名称</span><br><span class="line"></span><br><span class="line">    public void consume() &#123;</span><br><span class="line">        Properties props = new Properties();</span><br><span class="line">        // 必须设置的属性</span><br><span class="line">        props.put(&quot;bootstrap.servers&quot;, &quot;127.0.0.1:9092&quot;);</span><br><span class="line">        props.put(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</span><br><span class="line">        props.put(&quot;value.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</span><br><span class="line">        props.put(&quot;group.id&quot;, &quot;group-user&quot;);</span><br><span class="line">        // 自动提交offset,每1s提交一次（提交后的消息不再消费，避免重复消费问题）</span><br><span class="line">        props.put(&quot;enable.auto.commit&quot;, &quot;true&quot;);// 自动提交offset:true【PS：只有当消息提交后，此消息才不会被再次接受到】</span><br><span class="line">        props.put(&quot;auto.commit.interval.ms&quot;, &quot;1000&quot;);// 自动提交的间隔</span><br><span class="line">        /**</span><br><span class="line">         * 消费方式配置</span><br><span class="line">         * earliest： 当各分区下有已提交的offset时，从提交的offset开始消费；无提交的offset时，从头开始消费</span><br><span class="line">         * latest： 当各分区下有已提交的offset时，从提交的offset开始消费；无提交的offset时，消费新产生的该分区下的数据</span><br><span class="line">         * none： topic各分区都存在已提交的offset时，从offset后开始消费；只要有一个分区不存在已提交的offset，则抛出异常</span><br><span class="line">         */</span><br><span class="line">        props.put(&quot;auto.offset.reset&quot;, &quot;earliest &quot;);</span><br><span class="line">        // 拉取消息设置，每次poll操作最多拉取多少条消息（一般不主动设置，取默认的就好）</span><br><span class="line">        props.put(&quot;max.poll.records&quot;, &quot;100 &quot;);</span><br><span class="line"></span><br><span class="line">        //根据上面的配置，新增消费者对象</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = new KafkaConsumer&lt;&gt;(props);</span><br><span class="line">        // 订阅topic-user topic</span><br><span class="line">        consumer.subscribe(Collections.singletonList(topicUser));</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            //  从服务器开始拉取数据</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(100));</span><br><span class="line">            records.forEach(record -&gt; &#123;</span><br><span class="line">                System.out.printf(&quot;成功消费消息：topic = %s ,partition = %d,offset = %d, key = %s, value = %s%n&quot;, </span><br><span class="line">                                  record.topic(), record.partition(), record.offset(), record.key(), record.value());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://cloud-tour.github.io/2023/03/09/kafka/" title="Kafka" target="_blank" rel="external">http://cloud-tour.github.io/2023/03/09/kafka/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/Cloud-Tour" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar2.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/Cloud-Tour" target="_blank"><span class="text-dark">Cloud-Tour</span><small class="ml-1x">Development Engineer &amp; Java</small></a></h3>
        <div>A man who wants to float on the cloud</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2023/03/07/%E5%9F%BA%E7%A1%80/" title="基础"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="Catalogue" role="button">    <span>[&nbsp;</span><span>Catalogue</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>$</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>Maybe you could buy me a cup of coffee.</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="Scan Qrcode" title="Scan" />
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open alipay app scan this qrcode, buy me a coffee!</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="Scan Qrcode" title="Scan" />
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open wechat app scan this qrcode, buy me a coffee!</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> alipay</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> wechat payment</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/Cloud-Tour" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>